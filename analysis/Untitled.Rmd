---
title: "App NL-G-F 12m microarray"
author: "Karissa"
date: "12/02/2021"
output: html_document
  code_folding: hide
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: false
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

# setup
```{r}
library(tidyverse)
library(magrittr)
library(limma)
library(GEOquery)
library(affy)
library(kableExtra)
library(ggfortify)
library(ggeasy)
library(mogene20stprobeset.db)
library(mogene20sttranscriptcluster.db)
library(oligo)
library(msigdbr)
library(readxl)
library(pheatmap)
library(RColorBrewer)
library(viridis)
library(UpSetR)
library(fgsea)
library(harmonicmeanp)
library(ggpubr)
library(ggpol)
library(cowplot)
library(gridExtra)
library(lattice)
library(grid)
library(arrayQualityMetrics)
library(factoextra)
library(cluster) 

# This code loads the flat violin function in the working environment
source("https://gist.githubusercontent.com/benmarwick/2a1bb0133ff568cbe28d/raw/fb53bd97121f7f9ce947837ef1a4c65a73bffb3f/geom_flat_violin.R")
```

# Introduction

This document will contain my analysis of the microarray data of 12-months old male mice from two mouse models:
AppNL-G-F/NL-G-F mice, harboring three pathogenic App-knock-in mutations that promote aggressive amyloidosis by increasing total Aβ production (Swedish mutation KM670/671NL), increasing the Aβ42/Aβ40 ratio (Iberian mutation I716F), and promoting Aβ aggregation through facilitating oligomerization and reducing proteolytic degradation (Arctic mutation E693G), under the control of the endogenous APP promoter \n \n

3xTg-AD-H mouse carrying two mutated human overexpressed transgenes, APP (Swedish KM670/671NL) and MAPT (P301L), driven by exogenous Thy1.2 promoter with a knock-in mutation of Psen1 (M146V), together with their correspondent controls (male, n=3 for each group). 

It does not appear to be littermate controls. 

Summary of samples:
```{r}
geo <- getGEO(filename="GSE92926_series_matrix.txt") %>% 
  pData() 
  
geo %>% 
  dplyr::select(`genotype:ch1`, `age:ch1`, `tissue:ch1`, supplementary_file) %>% 
  kable(caption = "summary of samples") %>% 
  kable_styling()
```
## import data 
First I will obtain the expression data. Since this array is a MoGene T array, I will use the `oligo` package will be used to import the expression values from the *.CEL* files .

```{r}
setwd("data/AppNL-G-F.microarray/celFiles")
exp.cel <- read.celfiles(list.celfiles( full.names = T))

# tidy ip column names 
colnames(exp.cel) %<>% 
  str_remove("^GSM24404[:digit:]+_") %>% 
  str_remove("_MoGene-2_0-st_.CEL") %>% 
  str_remove("_MoGene-2_0-st.CEL")

targets <- colnames(exp.cel) %>% 
  as_tibble() %>% 
  set_colnames("sample") %>% 
  mutate(Genotype = case_when(
    grepl(sample, pattern = "APPNL") ~ "APP_NLGF", 
    grepl(sample, pattern = "APPWT") ~ "APP_WT", 
    grepl(sample, pattern = "3xTg") ~ "AD3xTg",
    grepl(sample, pattern = "non-Tg") ~ "Non_Tg") %>% 
      as.factor(), 
    Genotype = factor(Genotype, levels = c("APP_WT", "APP_NLGF", "Non_Tg", "AD3xTg")))

pData(exp.cel) %<>% 
  as.data.frame() %>% 
  rownames_to_column("sample") %>% 
  left_join(targets) %>% 
  column_to_rownames("sample") 

# set wd back to home dir
setwd("../../../")
```

<!-- # Qualtiy control of the raw data -->

<!-- ## PCA plot -->
<!-- First I will perform principal component analysis on the raw data. Here we check for outliers and try to see whether the data clusters as expected, e.g. by the experimental conditions. in this plot of PC1 against PC2, samples do not overly seperate by genotype.  -->
<!-- ```{r} -->
<!-- pca_raw <- log2(exprs(exp.cel)) %>%  -->
<!--   t() %>%  -->
<!--   prcomp() %>%  -->
<!--   autoplot(data = tibble(sample = rownames(.$x)) %>% -->
<!--              left_join(targets),  -->
<!--            colour = "Genotype",  -->
<!--            size = 4) + -->
<!--   theme_bw() + -->
<!--   theme(aspect.ratio = 1) -->

<!-- pca_raw -->
<!-- ``` -->

<!-- ## Boxplot -->

<!-- ```{r} -->
<!-- exprs(exp.cel) %>%  -->
<!--   log2() %>%  -->
<!--     as.data.frame() %>%  -->
<!--     rownames_to_column("probeID") %>%  -->
<!--     gather(key = "sample", value = "expression", -->
<!--            targets$sample) %>%  -->
<!--     left_join(pData(exp.cel) %>%  -->
<!--                 as.data.frame() %>%  -->
<!--                 rownames_to_column("sample")) %>%  -->
<!--     ggplot(aes(x = sample, y = expression)) + -->
<!--     geom_boxplot(aes(fill = Genotype), width = 0.2) + -->
<!--     geom_flat_violin(aes(fill = Genotype),  -->
<!--                      colour = NA, -->
<!--                      position = position_nudge(x = .2)) + -->
<!--     #ggtitle("Boxplot of expression values") + -->
<!--     theme_bw() + -->
<!--     easy_rotate_x_labels(angle = 315) -->
<!-- ``` -->

<!-- ## array quality metrics -->

<!-- Next I will use the `arrayQualityMetrics` package for more  generate a report for assistance in detecting outliers.  It will generate an additional control file containing the quality control plots together with a description of their aims and an identification of possible outliers. Inspection of this document did not reveal any outliers to be remvoed. -->

<!-- ```{r} -->
<!-- arrayQualityMetrics( -->
<!--   expressionset = exp.cel, -->
<!--   force = TRUE,  -->
<!--   do.logtransform = TRUE, -->
<!--   intgroup = "Genotype" -->
<!--   ) -->
<!-- ``` -->